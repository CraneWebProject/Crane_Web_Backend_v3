pipeline {
    agent any

    environment {
        SERVICE_NAME = 'api-gateway'
        IMAGE_TAG = "api-gateway:latest"
        LOCAL_PORT = "8080"
        // âœ… í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        JWT_KEY = credentials('JWT_KEY')
        REDIS_HOST = credentials('REDIS_HOST')
        REDIS_PORT = credentials('REDIS_PORT')
        EUREKA_URL = credentials('EUREKA_URL')
    }

    stages {
        stage('Check Environment Variables') {
            steps {
                script {
                    echo "âœ… Jenkins í™˜ê²½ ë³€ìˆ˜ í™•ì¸..."
                    echo "ğŸ” REDIS_HOST: $REDIS_HOST"
                    echo "ğŸ” REDIS_PORT: $REDIS_PORT"
                }
            }
        }

        stage('Check Changes') {
            steps {
                script {
                    def changes = sh(script: "git diff --name-only HEAD^", returnStdout: true).trim()
                    def serviceChanged = changes.split('\n').any { it.startsWith('api-gateway/') }

                    if (!serviceChanged) {
                        currentBuild.result = 'NOT_BUILT'
                        error('No changes in api-gateway directory, skipping build')
                    }
                    echo "âœ… api-gateway ë³€ê²½ ì‚¬í•­ ê°ì§€ë¨. ë¹Œë“œë¥¼ ì§„í–‰í•©ë‹ˆë‹¤."
                }
            }
        }

        stage('Checkout') {
            steps {
                git branch: 'msa',
                    url: 'https://github.com/CraneWebProject/Crane_Web_Backend_v3'

                script {
                    def gitCommit = sh(script: 'git rev-parse HEAD', returnStdout: true).trim()
                    echo "âœ… í˜„ì¬ ë¹Œë“œí•˜ëŠ” ì»¤ë°‹: ${gitCommit}"
                }
            }
        }

        stage('Build') {
            steps {
                dir('api-gateway') {
                    sh '''
                        chmod +x gradlew
                        ./gradlew clean build -x test
                    '''
                }
            }
            post {
                success {
                    echo "âœ… Build ë‹¨ê³„ ì™„ë£Œ"
                }
                failure {
                    error "âŒ Build ë‹¨ê³„ ì‹¤íŒ¨"
                }
            }
        }

        stage('Docker Build & Run') {
            steps {
                script {
                    sh '''
                    echo "ğŸ” í˜„ì¬ REDIS_HOST ê°’: $REDIS_HOST"
                    echo "ğŸ” í˜„ì¬ REDIS_PORT ê°’: $REDIS_PORT"

                    docker build -t $IMAGE_TAG \
                        --build-arg JWT_KEY=$JWT_KEY \
                        --build-arg REDIS_HOST=$REDIS_HOST \
                        --build-arg REDIS_PORT=$REDIS_PORT \
                        --build-arg EUREKA_URL=$EUREKA_URL \
                        api-gateway/

                    # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¢…ë£Œ í›„ ì‚­ì œ
                    docker stop $SERVICE_NAME || true
                    docker rm $SERVICE_NAME || true

                    # ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰
                    docker run -d --name $SERVICE_NAME \
                        -e JWT_KEY=$JWT_KEY \
                        -e REDIS_HOST=$REDIS_HOST \
                        -e REDIS_PORT=$REDIS_PORT \
                        -e EUREKA_URL=$EUREKA_URL \
                        -p $LOCAL_PORT:8080 $IMAGE_TAG
                    '''
                }
            }
        }
    }

    post {
        success {
            echo """
            ===========================================
            âœ… Pipeline Successfully Completed
            Service: ${SERVICE_NAME}
            Image: ${IMAGE_TAG}
            Port: ${LOCAL_PORT}
            ===========================================
            """
        }
        failure {
            echo """
            ===========================================
            âŒ Pipeline Failed
            Service: ${SERVICE_NAME}
            Stage: ${currentBuild.result}
            ===========================================
            """
        }
        always {
            cleanWs()
        }
    }
}
